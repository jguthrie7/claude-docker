services:
  claude-dev:
    build:
      context: .
      args:
        USERNAME: node
    image: claude-code-dev-${PROJECT_NAME:-claude-docker}:latest
    hostname: ${PROJECT_NAME:-claude-docker}

    stdin_open: true
    tty: true

    volumes:
      # Your workspace
      - ./workspace:/workspace

      # Mount the .claude directory (for credentials and data)
      - ./claude-auth:/home/node/.claude

      # Mount Claude Code configuration file (persists settings, user ID, project state)
      - ./claude-config.json:/home/node/.claude.json

      # SSH Agent Forwarding - Auto-configured by Makefile based on platform
      - ${SSH_MOUNT:-/dev/null:/dev/null}

    environment:
      - USER=node
      - GITHUB_USER=${GITHUB_USER}
      - GITHUB_EMAIL=${GITHUB_EMAIL}

      # SSH Agent Forwarding - Auto-configured by Makefile based on platform
      - SSH_AUTH_SOCK=${SSH_SOCK}

      # Add MCP-related API keys as needed
      # These will be available for manual MCP configuration
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY:-}
      - UPSTASH_REDIS_REST_URL=${UPSTASH_REDIS_REST_URL:-}
      - UPSTASH_REDIS_REST_TOKEN=${UPSTASH_REDIS_REST_TOKEN:-}

    # Port mappings for macOS (host networking doesn't work on macOS)
    ports:
      - "4321:4321"  # Astro dev server
      - "3000:3000"  # Common dev server port
      - "5173:5173"  # Vite dev server
      - "8080:8080"  # Common app port

    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
